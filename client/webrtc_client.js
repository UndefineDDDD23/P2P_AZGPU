const socket = new WebSocket("ws://localhost:8080/");
const localVideo = document.getElementById("localVideo");
const remoteVideosContainer = document.getElementById("remoteVideosContainer");
const roomIdInput = document.getElementById("roomIdInput");
const shareScreenButton = document.getElementById("shareScreen");
const toggleCameraButton = document.getElementById("toggleCamera");
const toggleMicButton = document.getElementById("toggleMic");

let roomId;
let peerConnections = {}; // –°–ø–∏—Å–æ–∫ RTCPeerConnection –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
let localStream;
let screenStream = null; // –ü–æ—Ç–æ–∫ —ç–∫—Ä–∞–Ω–∞
let isCameraEnabled = true;
let isMicEnabled = true;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ URL
function getQueryParam(param) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(param);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π WebSocket
socket.onmessage = (event) => {
  const data = JSON.parse(event.data);

  switch (data.type) {
    case 'new-peer':
      handleNewPeer(data.peerId);
      break;

    case 'signal':
      handleSignal(data.peerId, data.signalData);
      break;

    case 'peer-left':
      handlePeerLeft(data.peerId);
      break;

    // –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–Ω–∞—Ç—ã
    case 'room-created':
      let roomUrlElement = document.getElementById("room_URL");
      roomUrlElement.href = data.url;
      roomUrlElement.innerText = data.url;
      console.log("–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!\nRoom ID: " + data.roomId + "\n–ö–ª—é—á: " + data.secretKey + "\nURL: " + data.url);
      break;

    default:
      console.log("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:", data.type);
  }
};

// –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ. –ï—Å–ª–∏ –≤ URL –∑–∞–¥–∞–Ω—ã roomId –∏ key, —Ç–æ –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è.
async function joinRoom() {
  // –ï—Å–ª–∏ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –≤–≤–µ–¥–µ–Ω–æ, –ø—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å roomId –∏–∑ URL
  roomId = roomIdInput.value || getQueryParam('roomId');
  const key = getQueryParam('key');

  if (!roomId || !key) {
    alert("–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ –≤ URL –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–¥–∞–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã roomId –∏ key.");
    return;
  }

  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    localVideo.srcObject = localStream;
    console.log("Local video track: " + localStream.getVideoTracks()[0].id);
    // –ü–µ—Ä–µ–¥–∞—ë–º —Ç–∞–∫–∂–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á
    socket.send(JSON.stringify({ type: "join-room", roomId, key }));
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ:", error);
  }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function handleNewPeer(peerId) {
  let peerConnection = peerConnections[peerId];
  if (!peerConnection) {
    peerConnection = createPeerConnection(peerId);
    peerConnections[peerId] = peerConnection;
  }
  console.log(`üé• –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π localStream ID: ${localStream.id}`);
  localStream.getTracks().forEach((track) => {
    console.log(`üé§ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞: ${track.id} (kind: ${track.kind}) –≤ PeerConnection ${peerId}`);
    peerConnection.addTrack(track, localStream);
  });

  console.log("Generate offer and send video track to: " + peerId + " Track: " + localStream.getVideoTracks()[0].id);
  peerConnection.createOffer().then((offer) => {
    peerConnection.setLocalDescription(offer);
    console.log(offer);

    socket.send(JSON.stringify({
      type: "signal",
      roomId,
      targetId: peerId,
      signalData: offer
    }));
  }).catch((error) => console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer:", error));
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function handleSignal(peerId, signalData) {
  let peerConnection = peerConnections[peerId];
  if (!peerConnection) {
    peerConnection = createPeerConnection(peerId);
    peerConnections[peerId] = peerConnection;
  }

  if (signalData.type === "offer") {
    console.log(`Offer from ${peerId}: `);

    peerConnection.setRemoteDescription(new RTCSessionDescription(signalData));

    console.log(signalData);
    console.log(`üé• –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π localStream ID: ${localStream.id}`);
    localStream.getTracks().forEach((track) => {
      console.log(`üé§ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞: ${track.id} (kind: ${track.kind}) –≤ PeerConnection ${peerId}`);
      peerConnection.addTrack(track, localStream);
    });

    console.log("Send answer to: " + peerId + " Track: " + localStream.getVideoTracks()[0].id);
    peerConnection.createAnswer().then((answer) => {
      peerConnection.setLocalDescription(answer);
      console.log(answer);

      socket.send(JSON.stringify({
        type: "signal",
        roomId,
        targetId: peerId,
        signalData: answer
      }));
    }).catch((error) => console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è answer:", error));
  } else if (signalData.type === "answer") {
    console.log(`üì© –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç ${peerId}:`, signalData);

    peerConnection.setRemoteDescription(new RTCSessionDescription(signalData))
      .then(() => console.log(`‚úÖ Remote Description —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è ${peerId}`))
      .catch(error => console.error(`‚ùå –û—à–∏–±–∫–∞ setRemoteDescription:`, error));
  } else if (signalData.candidate) {
    peerConnection.addIceCandidate(new RTCIceCandidate(signalData)).catch((error) => {
      console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–∞:", error);
    });
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function handlePeerLeft(peerId) {
  const remoteVideo = document.getElementById(`remote-video-${peerId}`);
  if (remoteVideo) {
    remoteVideo.remove();
  }

  if (peerConnections[peerId]) {
    peerConnections[peerId].close();
    delete peerConnections[peerId];
  }
}

// –°–æ–∑–¥–∞–Ω–∏–µ RTCPeerConnection (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function createPeerConnection(peerId) {
  var configuration = {
    iceServers: [
      { 'url': 'stun:stun.l.google.com:19302' },
      {
        'url': 'turn:192.158.29.39:3478?transport=udp',
        'credential': 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
        'username': '28224511:1379330808'
      },
      {
        'url': 'turn:192.158.29.39:3478?transport=tcp',
        'credential': 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
        'username': '28224511:1379330808'
      }
    ],
    offerToReceiveAudio: true,
    offerToReceiveVideo: true,
  }
  const peerConnection = new RTCPeerConnection(configuration);

  peerConnection.ontrack = (event) => {
    if (event.track.kind === "video") {
      console.log(event.streams[0], event.track.id)
      const remoteVideo = document.createElement("video");
      remoteVideo.id = `remote-video-${peerId}`;
      remoteVideo.srcObject = event.streams[0];
      remoteVideo.autoplay = true;
      remoteVideo.muted = true;
      remoteVideosContainer.appendChild(remoteVideo);
    }
    if (event.track.kind === "audio") {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ-—Ç—Ä–µ–∫–∞ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
    }
  };

  peerConnection.onicecandidate = (event) => {
    if (event.candidate) {
      socket.send(JSON.stringify({
        type: "signal",
        roomId,
        targetId: peerId,
        signalData: event.candidate
      }));
    }
  };

  return peerConnection;
}

// –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
async function shareScreen() {
  try {
    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
    const screenTrack = screenStream.getTracks()[0];

    Object.values(peerConnections).forEach((peerConnection) => {
      const sender = peerConnection.getSenders().find((s) => s.track.kind === "video");
      if (sender) {
        sender.replaceTrack(screenTrack);
      }
    });

    screenTrack.onended = () => {
      stopScreenShare();
    };

    console.info("–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –Ω–∞—á–∞—Ç–∞");
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞:", error);
  }
}

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function stopScreenShare() {
  if (screenStream) {
    const videoTrack = localStream.getVideoTracks()[0];
    Object.values(peerConnections).forEach((peerConnection) => {
      const sender = peerConnection.getSenders().find((s) => s.track.kind === "video");
      if (sender) {
        sender.replaceTrack(videoTrack);
      }
    });
    screenStream.getTracks().forEach((track) => track.stop());
    screenStream = null;
    console.info("–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
  }
}

// –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function toggleCamera() {
  isCameraEnabled = !isCameraEnabled;
  localStream.getVideoTracks()[0].enabled = isCameraEnabled;
  console.info("–ö–∞–º–µ—Ä–∞ " + (isCameraEnabled ? "–≤–∫–ª—é—á–µ–Ω–∞" : "–≤—ã–∫–ª—é—á–µ–Ω–∞"));
}

// –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function toggleMic() {
  isMicEnabled = !isMicEnabled;
  localStream.getAudioTracks()[0].enabled = isMicEnabled;
  console.info("–ú–∏–∫—Ä–æ—Ñ–æ–Ω " + (isMicEnabled ? "–≤–∫–ª—é—á–µ–Ω" : "–≤—ã–∫–ª—é—á–µ–Ω"));
}

// –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç –∫–æ–º–Ω–∞—Ç—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function leaveRoom() {
  if (!roomId) return;

  socket.send(JSON.stringify({ type: "leave-room", roomId }));

  if (localStream) {
    localStream.getTracks().forEach((track) => track.stop());
  }

  Object.values(peerConnections).forEach((peerConnection) => peerConnection.close());
  peerConnections = {};

  roomId = null;
  console.info("–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç –∫–æ–º–Ω–∞—Ç—ã");
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã (–ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
function createRoom() {
  const adminPassword = document.getElementById("adminPasswordInput").value;
  if (!adminPassword) {
    alert("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!");
    return;
  }
  socket.send(JSON.stringify({ type: "create-room", adminPassword }));
}

// –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–Ω–æ–ø–æ–∫
shareScreenButton.onclick = shareScreen;
toggleCameraButton.onclick = toggleCamera;
toggleMicButton.onclick = toggleMic;

setTimeout(() => {
  console.log(peerConnections);
}, 3000);
